

[//]: # (README.md generated by gotmpl. DO NOT EDIT.)

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![Version: 0.0.1](https://img.shields.io/badge/Version-0.0.1-informational?style=flat-square) ![AppVersion: 0.0.1](https://img.shields.io/badge/AppVersion-0.0.1-informational?style=flat-square)

# Kubee K3s-ansible Cluster Chart

This [Kubee chart](https://github.com/EraldyHq/kubee/blob/main/docs/site/kubee-helmet-chart.md) is a [cluster chart](https://github.com/EraldyHq/kubee/blob/main/docs/site/cluster-chart.md)
that will install [k3s Kubernetes distribution](https://docs.k3s.io/) on your hosts
with the [official k3s-ansible playbooks](https://github.com/k3s-io/k3s-ansible).

## Features

### Automatic OIDC Configuration

If [dex](../dex/README.md) is enabled, it is configured as [OIDC issuer](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens)

ie in the [template](#template), the following arguments are added:
```yaml
k3s_extra_server_args:
  - --kube-apiserver-arg="oidc-issuer-url=https://dex-hostname.tld"
  - --kube-apiserver-arg="oidc-client-id=kubernetes"
  - --kube-apiserver-arg="oidc-username-claim=email"
  - --kube-apiserver-arg="oidc-groups-claim=groups"
```

You can then log in with [kubelogin](https://github.com/int128/kubelogin)

## Command

### Template

Verify the configuration. The template will output the ansible inventory file
```bash
kubee --cluster clusterName helmet template k3s-ansible
```

### Play

The `play` command deploys Kubernetes on the cluster hosts (Repeatable install and configuration)

```bash
kubee --cluster clusterName --cluster-chart k3s-ansible cluster play
```
Play will execute the [site playbook](https://github.com/gerardnico/ansible-e-base-collection/blob/main/playbooks/kubee_site.yml)

### Upgrade

* [Choose the next minor version](../../website/src/content/docs/k3s/upgrade.md)
* Change it in your [cluster file](../../website/src/content/docs/cluster/cluster-values.md) in the [version value](values.yaml)
* Run:
```bash
kubee --cluster clusterName --cluster-chart k3s-ansible cluster upgrade
```
Upgrade will execute the [upgrade playbook](https://github.com/k3s-io/k3s-ansible/blob/master/playbooks/upgrade.yml)`

### Uninstall

!!! Uninstall will delete Kubernetes on all Nodes. !!!

```bash
kubee --cluster clusterName --cluster-chart k3s-ansible cluster uninstall
```

Uninstall will execute the [reset playbook](https://github.com/k3s-io/k3s-ansible/blob/master/playbooks/reset.yml)

### Restart k3s

Restart k3s
```bash
kubee --cluster clusterName --cluster-chart k3s-ansible cluster restart
```

It will execute the [restart playbook](https://github.com/gerardnico/ansible-e-base-collection/blob/main/playbooks/kubee_restart.yml)

### Rotate certs

[Rotate Certs](https://docs.k3s.io/cli/certificate#rotating-client-and-server-certificates)
```bash
kubee --cluster clusterName --cluster-chart k3s-ansible cluster rotate-certs
```

It will execute the [rotate-certs playbook](https://github.com/gerardnico/ansible-e-base-collection/blob/main/playbooks/kubee_rotate_certs.yml)

This action is normally not needed as `k3s` will automatically rotate certs at restart but as always
there was a [change](https://github.com/k3s-io/k3s/discussions/10024#discussioncomment-12073740).

### Reboot the nodes

Reboot the servers hosts then the agents hosts.
```bash
kubee --cluster clusterName --cluster-chart k3s-ansible cluster uninstall
```

Reboot will execute the [reboot playbook](https://github.com/k3s-io/k3s-ansible/blob/master/playbooks/reboot.yml)

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| hosts.all.admin_user | object | `{"public_key":"","username":""}` | [Optional] - An extra admin user added to the Host OS. (ie in the wheel group, used when ssh was hardened by banning root connection). The name and public key should not be empty. |
| hosts.all.connection | object | `{"type":"ssh","username":"root"}` | Connection |
| hosts.all.upgrade_cron | string | `"0 2 * * 0"` | [Optional] - Upgrade cron. A cron expression to schedule the upgrade of the os |
| hosts.servers | list | `[]` | The Servers (Mandatory) The number of hosts server must be odd to avoid split brain issues with etcd The minimum number is: - 1 for a single server cluster - 3 for a [high availability cluster](https://docs.k3s.io/datastore/ha-embedded) |
| restart_cron | string | `"0 11 * * *"` | A cron expression to schedule a k3s restart A restart is mandatory as k3s performs database operation at startup such as compaction. Restarting k3s does not stop the containers, the apps are still working |
| server_args | list | `[]` | The [k3s Server Args](https://docs.k3s.io/cli/server) Example: `--kube-apiserver-arg="admission-control-config-file=/var/lib/rancher/k3s/server/psa.yaml"` |
| token | string | `""` | The [k3s Token](https://docs.k3s.io/cli/token) (Mandatory). A random secret value that should not change ever because it's used to encrypt the data on disk. You can generate one with `openssl rand -base64 64 | tr -d '\n'`) |
| version | string | `"v1.32.2+k3s1"` | The [K3s version](https://github.com/k3s-io/k3s/releases) |
