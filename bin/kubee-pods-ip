#!/bin/bash
# @name kube-pods-ip
# @brief Shows the pods ip
# @description
#     Shows the pods ip
#     A node name can be given to show only the pods of a node
#

set -Eeuo pipefail

if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
  if [ ! -d "$BASHLIB_PATH" ]; then
    echo "BASHLIB_PATH was not set and could not be found"
    exit 1
  fi
fi
export PATH="$BASHLIB_PATH:$PATH"

source bashlib-echo.sh
source bashlib-error.sh
error::set_trap

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
# add to the path as we source the scripts
export PATH="$SCRIPT_DIR:$PATH"
# shellcheck source=./kubee-lib.sh
source "kubee-lib.sh"

######################
# Main
######################

usage(){
  echo "Usage:"
  echo ""
  echo "Shows the pods ip"
  echo ""
  echo '```bash'
  echo "$(basename "$0") [node name]"
  echo '```'
  # shellcheck disable=SC2016
  echo 'If `node name` is provided, the pods of this node will only be shown'

}

if [[ "${1:-}" == "synopsis" ]]; then
  usage
  exit
fi

# Help ?
NODE_NAME=${1:-}
if [[ $NODE_NAME =~ -h|help ]]; then
  usage
  exit
fi


# Get env
kubee::set_kubeconfig_env || error::exit $?


# Check if the node name is provided
if [ "$NODE_NAME" != "" ]; then
  NAMESPACE_JSONPATH="{range .items[?(@.spec.nodeName==\"$1\")]}{.status.podIP}{\" \"}{.metadata.name}{\"\n\"}{end}"
  # shellcheck disable=SC2016
  AWK_PRINTF='
              BEGIN { print "IP      POD NAME   "
                      print "----      ------     --------  ----------------" }
                    { printf "%12s  %s\n", $1, $2}
              '
else
  NAMESPACE_JSONPATH='{range .items[*]}{.status.podIP}{" "}{.spec.nodeName}{" "}{.metadata.name}{"\n"}{end}'
  # shellcheck disable=SC2016
  AWK_PRINTF='
            BEGIN { print "IP            NODE NAME                       POD NAME   "
                    print "------------  ------------------------------- ---------------------------" }
                  { printf "%12s  %-30s %s\n", $1, $2, $3}
            '
fi


kubectl get pods --all-namespaces -o jsonpath="$NAMESPACE_JSONPATH" | awk "$AWK_PRINTF"
